<!Doctype html>
<html lang="ko">

<head>
  <meta charset="utf-8" />
  <title>Tag Bookmark</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    li {
      list-style: none;
    }
    * {
     padding: 0;
      margin: 0;
      box-sizing: border-box;
    }
    :root {
      --bg: #0b0c10;
      --fg: #eaf0f1;
      --muted: #9aa0a6;
      --card: #11151a;
      --accent: #4f8cff;
    }

    body {
      margin: 0;
      font: 14px/1.4 system-ui, -apple-system, Segoe UI, Roboto, sans-serif;
      background: var(--bg);
      color: var(--fg);
    }

    .bar {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 12px 16px;
      border-bottom: 1px solid #222;
    }

    .controls {
      display: grid;
      gap: 8px;
      padding: 12px 16px;
      background: var(--card);
      border-bottom: 1px solid #222;
    }

    #add-form {
      display: grid;
      grid-template-columns: 1fr 1fr 1fr auto;
      gap: 8px;
    }

    .filters {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .grid {
      display: grid;
      gap: 10px;
      grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
      padding: 16px;
    }

    .card {
      background: var(--card);
      border: 1px solid #1c2430;
      border-radius: 12px;
      padding: 12px;
      display: grid;
      gap: 8px;
    }

    .card h3 {
      margin: 0;
      font-size: 15px;
    }

    .muted {
      color: var(--muted);
    }

    .tags {
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
    }

    .tag {
      padding: 2px 8px;
      border-radius: 999px;
      background: var(--card);
      color: var(--muted);
      cursor: pointer;
      user-select: none;
      border-width: 1px;
      border-style: solid;
      border-color: var(--fg)
    }
    .tag.selected {
      background-color: var(--accent);
      color: white;
      border-color: var(--accent);
    }

    .actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }

    button,
    input,
    select {
      background: var(--card);
      color: var(--fg);
      border: 1px solid #273040;
      border-radius: 8px;
      padding: 8px;
    }

    button {
      cursor: pointer;
    }

    .stats {
      padding: 12px 16px;
      border-top: 1px solid #222;
      display: flex;
      gap: 16px;
      flex-wrap: wrap;
      color: var(--muted);
    }

    .light {
      --bg: #f7f8fb;
      --fg: #0b0c10;
      --muted: #566;
      --card: #ffffff;
      --accent: #2a66ff;
    }

    .toast {
      background: #111a;
      backdrop-filter: blur(6px);
      color: #fff;
      padding: 10px 12px;
      border-radius: 10px;
    }

    #toast-root {
      position: fixed;
      right: 16px;
      bottom: 16px;
      display: grid;
      gap: 8px;
    }

    a {
      color: var(--accent);
      text-decoration: none;
    }

    a:hover {
      text-decoration: underline;
    }

    @media (max-width:720px) {
      #add-form {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>

<body>
  <header class="bar">
    <h1>Tag Notes (Lite)</h1>
    <div style="display:flex;gap:8px;">
      <button type="button" id="theme-btn">üåì</button>
    </div>
  </header>

  <section class="controls">
    <form id="add-form" autocomplete="off">
      <input id="title" placeholder="Ï†úÎ™©" required />
      <input id="url" placeholder="ÎßÅÌÅ¨(URL) ÎòêÎäî Î©îÎ™®" />
      <input id="tags" placeholder="ÌÉúÍ∑∏(ÏâºÌëúÎ°ú Íµ¨Î∂Ñ)" />
      <button type="submit">Ï∂îÍ∞Ä</button>
    </form>

    <div class="filters">
      <input id="q" placeholder="Í≤ÄÏÉâ(Ï†úÎ™©/ÌÉúÍ∑∏) ‚Äî 300ms ÎîîÎ∞îÏö¥Ïä§" />
      <select id="sort">
        <option value="recent">Ï†ïÎ†¨: ÏµúÏã†</option>
        <option value="title">Ï†ïÎ†¨: Ï†úÎ™©</option>
        <option value="tags">Ï†ïÎ†¨: ÌÉúÍ∑∏Ïàò</option>
      </select>
      <button type="button" id="clear-filters">ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî</button>
    </div>
  </section>

  <section class="grid" id="list"></section>
  <aside class="stats" id="stats"></aside>
  <div id="toast-root"></div>

  <script>
    /* =========================
              Ïú†Ìã∏ Ìï®Ïàò
    ========================= */
    const uid = () =>
        (crypto.randomUUID?.() /* Î∏åÎùºÏö∞Ï†ÄÍ∞Ä randomUUID ÏßÄÏõê Ïãú */
            || (Date.now() + Math.random().toString(16).slice(2)));

    // XSS Î∞©ÏßÄ
    const escapeHtml = s =>
        s.replace(/[&<>"']/g, m => ({ '&': '&amp;', '<': '&lt;', '>': '&gt;', '"': '&quot;', "'": '&#39;' }[m]));

    // ÏïûÎí§ Í≥µÎ∞± Ï†úÍ±∞(ÌÖçÏä§Ìä∏ Ï†ïÎ¶¨)
    const clamp = (s) => s.trim();

    // Tag Î∂ÑÎ¶¨
    const tagSplit = (s) => s.split(',').map(x => x.trim()).filter(x => x !== '');

    // url ÌôïÏù∏
    const isValidUrl = (url)  => {
      const pattern = /^(https?:\/\/)?([\w.-]+)+(:\d+)?(\/[\w./?%&=-]*)?$/i;
      return pattern.test(url);
    }

    /* =========================
              ÌÜ†Ïä§Ìä∏
    ========================= */
    const $toastRoot = document.getElementById('toast-root');

    function createToast(message, duration = 3000) {
      const toast = document.createElement('div');
      toast.className = 'toast';
      toast.textContent = message;

      $toastRoot.appendChild(toast);

      const timer = setTimeout(() => {
        toast.remove();
      }, duration);

      toast.addEventListener('click', () => {
        clearTimeout(timer);
        toast.remove();
      });
    }

    /* =========================
              ÏÉÅÌÉú Í¥ÄÎ¶¨
    ========================= */
    class Store {
      #storageKey = 'bookmark';

      constructor(initialState) {
        this.state = initialState;
        this.listeners = new Set();
        this.load();
      }

      get() {return this.state;}

      set(updater) {
        this.state = updater(this.state);
        this.save();
        this.emit();
      }

      subscribe(listener) {
        this.listeners.add(listener);
        return () => this.listeners.delete(listener);
      }

      emit() {
        for (const fn of this.listeners) fn(this.state);
      }

      filtered() {
        const {items, filter} = this.state;
        let copyItems = [...items]

        // Í≤ÄÏÉâ ÌïÑÌÑ∞
        if(filter.q) {
          let q = filter.q.toLowerCase();
          copyItems = copyItems.filter(copyItem =>
              copyItem.title.toLowerCase().includes(q) ||
              copyItem.tags.some(tag => tag.toLowerCase().includes(q))
          );
        }

        // ÌÉúÍ∑∏ ÌïÑÌÑ∞
        if(filter.selected.size > 0) {
          copyItems = copyItems.filter(copyItem =>
              copyItem.tags.some(tag => filter.selected.has(tag))
          );
        }

        // Ï†ïÎ†¨
        let sorted = filter.sort;
        sorted === 'recent' ?
            copyItems.sort((a,b) => b.createdAt - a.createdAt) :
        sorted === 'title' ?
            copyItems.sort((a,b) => a.title.localeCompare(b.title)) :
        sorted === 'tags' ?
            copyItems.sort((a,b) => b.tags.length - a.tags.length) :
            copyItems

        return copyItems;
      }

      save() {
        const saveData = {
          ...this.state,
          filter: {...this.state.filter, selected: [...this.state.filter.selected]}
        }
        localStorage.setItem(this.#storageKey,JSON.stringify(saveData));
      }

      load() {
        const saved = localStorage.getItem(this.#storageKey);
        if(!saved) return
        try {
          const result = JSON.parse(saved);
          result.filter.selected = new Set(result.filter.selected);
          this.state = result;
        } catch {}
      }
    }

    /* =========================
          Ï¥àÍ∏∞ ÏÉÅÌÉú & Ïä§ÌÜ†Ïñ¥
    ========================= */
    const initialState = {
      items: [],
      filter : {
        q: '',
        selected: new Set(),
        sort : 'recent',
      }
    }
    const store = new Store(initialState);
    store.subscribe(render);

    /* =========================
                ÎûúÎçî
    ========================= */
    const $list = document.getElementById('list');
    const $stats = document.getElementById('stats');

    function render() {
      // list Í∑∏Î¶¨Í∏∞
      const items = store.filtered();
      const state = store.get();

      $list.innerHTML = items.map(item => `
        <div class="card">
          <h3>${escapeHtml(item.title)}</h3>
          ${isValidUrl(item.url) ?
            `<a href="${escapeHtml(item.url)}" target="_blank" rel="noreferrer">${escapeHtml(item.url)}</a>` :
            `<p>${escapeHtml(item.url)}</p>`}
          <ul class="tags">
            ${item.tags.map(tag => `
              <li class="tag ${state.filter.selected.has(tag) ? 'selected' : ''}" data-tag="${escapeHtml(tag)}">${escapeHtml(tag)}</li>
            `).join('')}
          </ul>
          <div class="actions">
            <button data-del="${item.id}" data-title="${escapeHtml(item.title)}">ÏÇ≠Ï†ú</button>
          </div>
        </div>
      `).join('');

      // ÌÜµÍ≥Ñ
      const tagCount = new Map();

      state.items.forEach(item => {
        item.tags.forEach(tag => {
          tagCount.set(tag, (tagCount.get(tag) || 0) + 1)
        })
      });

      const topTags = [...tagCount.entries()]
      .sort((a,b) => b[1]-a[1])
      .slice(0,5)
      .map(([tag, cnt]) => `#${escapeHtml(tag)}(${cnt}Í∞ú)`);

      $stats.innerHTML = `
        <div>Ï¥ù ${state.items.length}Í∞ú<div>
        <div>ÏÑ†ÌÉù ÌÉúÍ∑∏ : ${[...state.filter.selected].map(escapeHtml).join(', ')}</div>
        <div>TOP5 : ${topTags.join(',') || 'ÏóÜÏùå'}</div>
      `
    }

    /* =========================
            Ïù¥Î≤§Ìä∏ Ìï∏Îì§ÎßÅ
    ========================= */
    // Ï∂îÍ∞Ä
    document.getElementById('add-form').addEventListener('submit', (e) => {
      e.preventDefault();
      const title = clamp(document.getElementById('title').value);
      if(!title) return;
      const url = clamp(document.getElementById('url').value);
      const tags = tagSplit(document.getElementById('tags').value);
      const item = {
        id: uid(),
        title,
        url,
        tags,
        createdAt : Date.now(),
      }
      store.set(state => ({
        ...state,
        items: [...state.items, item]
      }));
      e.target.reset();
      createToast(`"${title}" Ï∂îÍ∞ÄÎê®`);
    });

    // ÏÇ≠Ï†ú Î∞è ÌÉúÍ∑∏ ÌÅ¥Î¶≠
    $list.addEventListener('click', (e) => {
      const delId = e.target.dataset.del;
      if(delId) {
        store.set(state => ({
          ...state,
          items : state.items.filter(item => item.id !== delId)
        }));
        const title = e.target.dataset.title;
        createToast(`"${title}"Í∞Ä ÏÇ≠Ï†úÎêòÏóàÏäµÎãàÎã§.`);
      }

      const tag = e.target.dataset.tag;
      if(tag) {
        store.set(state => {
          const selected = new Set(state.filter.selected);
          console.log(selected);
          if(selected.has(tag)) selected.delete(tag);
          else selected.add(tag);
          return {...state, filter: {...state.filter, selected}}
        })
      }
    })

    // Í≤ÄÏÉâ
    let timer = null;
    document.getElementById('q').addEventListener('input', (e) => {
      clearTimeout(timer);
      timer = setTimeout(() => {
        const q = e.target.value;
        store.set(state => ({
          ...state,
          filter: {...state.filter, q}
        }));
      }, 300)
    });

    // Ï†ïÎ†¨
    document.getElementById('sort').addEventListener('change',(e) => {
      const sort = e.target.value;
      store.set(state => ({
        ...state,
        filter: {...state.filter, sort}
      }));
    })

    // ÌïÑÌÑ∞ Ï¥àÍ∏∞Ìôî
    document.getElementById('clear-filters').addEventListener('click', () => {
      store.set(state => ({
        ...state,
        filter: {q: "", selected: new Set(), sort: "recent"}
      }));
      document.getElementById('q').value = '';
      document.getElementById('sort').value = 'recent';
      createToast('ÌïÑÌÑ∞Í∞Ä Ï¥àÍ∏∞ÌôîÎêòÏóàÏäµÎãàÎã§.');
    });

    /* =========================
                UI
    ========================= */
    document.getElementById('theme-btn').addEventListener('click', () => {
      document.body.classList.toggle('light');
      localStorage.setItem('theme-light', document.body.classList.contains('light') ? '1' : '0');
    });

    /* =========================
              Ï¥àÍ∏∞ Î†åÎçî
    ========================= */
    // Ï¥àÍ∏∞ UI
    if (localStorage.getItem('theme-light') === '1') {
      document.body.classList.add('light');
    }
    // Í≤ÄÏÉâ, Ï†ïÎ†¨ ÌïÑÌÑ∞ Ï¥àÍ∏∞ ÏÑ∏ÌåÖ
    document.getElementById('sort').value = store.get().filter.sort;
    document.getElementById('q').value = store.get().filter.q;
    render();
  </script>
</body>

</html>